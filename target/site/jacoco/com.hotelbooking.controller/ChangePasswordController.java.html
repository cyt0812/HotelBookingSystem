<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChangePasswordController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HotelBookingSystem</a> &gt; <a href="index.source.html" class="el_package">com.hotelbooking.controller</a> &gt; <span class="el_source">ChangePasswordController.java</span></div><h1>ChangePasswordController.java</h1><pre class="source lang-java linenums">/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Class.java to edit this template
 */
package com.hotelbooking.controller;

import com.hotelbooking.dao.UserDAO;
import com.hotelbooking.entity.User;
import com.hotelbooking.util.SessionManager;
import javafx.application.Platform;
import javafx.fxml.FXML;
import javafx.scene.control.Label;
import javafx.scene.control.PasswordField;
import javafx.scene.control.ProgressBar;
import javafx.stage.Stage;

<span class="nc" id="L17">public class ChangePasswordController {</span>
    
    @FXML private PasswordField currentPasswordField;
    @FXML private PasswordField newPasswordField;
    @FXML private PasswordField confirmPasswordField;
    @FXML private ProgressBar passwordStrengthBar;
    @FXML private Label strengthLabel;
    @FXML private Label req1;
    @FXML private Label req2;
    @FXML private Label req3;
    @FXML private Label req4;
    @FXML private Label matchLabel;
    @FXML private Label errorLabel;
    @FXML private Label successLabel;
    
    private User currentUser;
    private UserDAO userDAO;
    private static final int MIN_PASSWORD_LENGTH = 8;
    
    @FXML
    public void initialize() {
<span class="nc" id="L38">        userDAO = new UserDAO();</span>
<span class="nc" id="L39">        currentUser = SessionManager.getCurrentUser();</span>
        
<span class="nc bnc" id="L41" title="All 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L42">            showError(&quot;No user logged in!&quot;);</span>
<span class="nc" id="L43">            return;</span>
        }
        
        // Add listeners for real-time validation
<span class="nc" id="L47">        newPasswordField.setOnKeyReleased(e -&gt; validatePasswordRequirements());</span>
<span class="nc" id="L48">        confirmPasswordField.setOnKeyReleased(e -&gt; checkPasswordMatch());</span>
        
<span class="nc" id="L50">        clearMessages();</span>
<span class="nc" id="L51">        System.out.println(&quot;‚úÖ Change password controller initialized for user: &quot; + currentUser.getUsername());</span>
<span class="nc" id="L52">    }</span>
    
    @FXML
    private void handleChangePassword() {
<span class="nc" id="L56">        clearMessages();</span>
        
        // Get input values
<span class="nc" id="L59">        String currentPassword = currentPasswordField.getText();</span>
<span class="nc" id="L60">        String newPassword = newPasswordField.getText();</span>
<span class="nc" id="L61">        String confirmPassword = confirmPasswordField.getText();</span>
        
        // Validation
<span class="nc" id="L64">        String validationError = validateInput(currentPassword, newPassword, confirmPassword);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!validationError.isEmpty()) {</span>
<span class="nc" id="L66">            showError(validationError);</span>
<span class="nc" id="L67">            return;</span>
        }
        
        try {
            // Verify current password
<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (!verifyCurrentPassword(currentPassword)) {</span>
<span class="nc" id="L73">                showError(&quot;‚ùå Current password is incorrect&quot;);</span>
<span class="nc" id="L74">                System.out.println(&quot;‚ö† Failed password verification attempt&quot;);</span>
<span class="nc" id="L75">                return;</span>
            }
            
            // ‚≠ê ‰øùÂ≠òÊñ∞ÂØÜÁ†ÅÂà∞Êï∞ÊçÆÂ∫ì
<span class="nc" id="L79">            boolean isUpdated = userDAO.updateUserPassword(currentUser.getId(), newPassword);</span>
            
<span class="nc bnc" id="L81" title="All 2 branches missed.">            if (isUpdated) {</span>
                // Update password in memory
<span class="nc" id="L83">                currentUser.setPassword(newPassword);</span>
<span class="nc" id="L84">                SessionManager.setCurrentUser(currentUser);</span>
                
<span class="nc" id="L86">                showSuccess(&quot;‚úÖ Password changed successfully!&quot;);</span>
<span class="nc" id="L87">                System.out.println(&quot;üíæ Password changed for user: &quot; + currentUser.getUsername());</span>
                
                // Clear fields
<span class="nc" id="L90">                currentPasswordField.clear();</span>
<span class="nc" id="L91">                newPasswordField.clear();</span>
<span class="nc" id="L92">                confirmPasswordField.clear();</span>
                
                // Close window after delay
<span class="nc" id="L95">                Platform.runLater(() -&gt; {</span>
                    try {
<span class="nc" id="L97">                        Thread.sleep(2000);</span>
<span class="nc" id="L98">                        closeWindow();</span>
<span class="nc" id="L99">                    } catch (InterruptedException e) {</span>
<span class="nc" id="L100">                        closeWindow();</span>
<span class="nc" id="L101">                    }</span>
<span class="nc" id="L102">                });</span>
            } else {
<span class="nc" id="L104">                showError(&quot;Failed to update password in database&quot;);</span>
            }
            
<span class="nc" id="L107">        } catch (Exception e) {</span>
<span class="nc" id="L108">            System.err.println(&quot;‚ùå Error changing password: &quot; + e.getMessage());</span>
<span class="nc" id="L109">            showError(&quot;Failed to change password. Please try again.&quot;);</span>
<span class="nc" id="L110">            e.printStackTrace();</span>
<span class="nc" id="L111">        }</span>
<span class="nc" id="L112">    }</span>
    
    @FXML
    private void handleCancel() {
<span class="nc" id="L116">        closeWindow();</span>
<span class="nc" id="L117">    }</span>
    
    /**
     * Validate all input fields
     */
    private String validateInput(String currentPassword, String newPassword, String confirmPassword) {
        // Check if fields are empty
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (currentPassword.isEmpty()) {</span>
<span class="nc" id="L125">            return &quot;Current password cannot be empty&quot;;</span>
        }
        
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (newPassword.isEmpty()) {</span>
<span class="nc" id="L129">            return &quot;New password cannot be empty&quot;;</span>
        }
        
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (confirmPassword.isEmpty()) {</span>
<span class="nc" id="L133">            return &quot;Please confirm your new password&quot;;</span>
        }
        
        // Check password length
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (newPassword.length() &lt; MIN_PASSWORD_LENGTH) {</span>
<span class="nc" id="L138">            return &quot;New password must be at least &quot; + MIN_PASSWORD_LENGTH + &quot; characters&quot;;</span>
        }
        
        // Check if passwords match
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!newPassword.equals(confirmPassword)) {</span>
<span class="nc" id="L143">            return &quot;New passwords do not match&quot;;</span>
        }
        
        // Check if new password is same as current
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (newPassword.equals(currentPassword)) {</span>
<span class="nc" id="L148">            return &quot;New password must be different from current password&quot;;</span>
        }
        
        // Check password strength requirements
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (!isPasswordStrong(newPassword)) {</span>
<span class="nc" id="L153">            return &quot;Password does not meet strength requirements&quot;;</span>
        }
        
<span class="nc" id="L156">        return &quot;&quot;;</span>
    }
    
    /**
     * Verify current password against stored password
     */
    private boolean verifyCurrentPassword(String inputPassword) {
<span class="nc" id="L163">        String storedPassword = currentUser.getPassword();</span>
        
        // In production, you would use password hashing and comparison
        // For now, simple comparison (‚ö† not recommended for production)
        // Example with BCrypt: return BCrypt.checkpw(inputPassword, storedPassword);
        
<span class="nc" id="L169">        return inputPassword.equals(storedPassword);</span>
    }
    
    /**
     * Validate password strength requirements
     */
    private boolean isPasswordStrong(String password) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        boolean hasLength = password.length() &gt;= MIN_PASSWORD_LENGTH;</span>
<span class="nc" id="L177">        boolean hasUpper = password.matches(&quot;.*[A-Z].*&quot;);</span>
<span class="nc" id="L178">        boolean hasLower = password.matches(&quot;.*[a-z].*&quot;);</span>
<span class="nc" id="L179">        boolean hasDigit = password.matches(&quot;.*[0-9].*&quot;);</span>
        
<span class="nc bnc" id="L181" title="All 8 branches missed.">        return hasLength &amp;&amp; hasUpper &amp;&amp; hasLower &amp;&amp; hasDigit;</span>
    }
    
    /**
     * Real-time password requirement validation
     */
    private void validatePasswordRequirements() {
<span class="nc" id="L188">        String password = newPasswordField.getText();</span>
        
<span class="nc bnc" id="L190" title="All 2 branches missed.">        boolean hasLength = password.length() &gt;= MIN_PASSWORD_LENGTH;</span>
<span class="nc" id="L191">        boolean hasUpper = password.matches(&quot;.*[A-Z].*&quot;);</span>
<span class="nc" id="L192">        boolean hasLower = password.matches(&quot;.*[a-z].*&quot;);</span>
<span class="nc" id="L193">        boolean hasDigit = password.matches(&quot;.*[0-9].*&quot;);</span>
        
        // Update requirement labels
<span class="nc" id="L196">        updateRequirement(req1, hasLength, &quot;‚úì At least 8 characters&quot;, &quot;‚úó At least 8 characters&quot;);</span>
<span class="nc" id="L197">        updateRequirement(req2, hasUpper, &quot;‚úì Contains uppercase letter (A-Z)&quot;, &quot;‚úó Contains uppercase letter (A-Z)&quot;);</span>
<span class="nc" id="L198">        updateRequirement(req3, hasLower, &quot;‚úì Contains lowercase letter (a-z)&quot;, &quot;‚úó Contains lowercase letter (a-z)&quot;);</span>
<span class="nc" id="L199">        updateRequirement(req4, hasDigit, &quot;‚úì Contains number (0-9)&quot;, &quot;‚úó Contains number (0-9)&quot;);</span>
        
        // Update strength bar and label
<span class="nc" id="L202">        updatePasswordStrength(hasLength, hasUpper, hasLower, hasDigit);</span>
<span class="nc" id="L203">    }</span>
    
    /**
     * Update individual requirement label
     */
    private void updateRequirement(Label label, boolean met, String metText, String unmetText) {
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (met) {</span>
<span class="nc" id="L210">            label.setText(metText);</span>
<span class="nc" id="L211">            label.setStyle(&quot;-fx-text-fill: #28a745;&quot;);</span>
        } else {
<span class="nc" id="L213">            label.setText(unmetText);</span>
<span class="nc" id="L214">            label.setStyle(&quot;-fx-text-fill: #dc3545;&quot;);</span>
        }
<span class="nc" id="L216">    }</span>
    
    /**
     * Update password strength bar and label
     */
    private void updatePasswordStrength(boolean hasLength, boolean hasUpper, boolean hasLower, boolean hasDigit) {
<span class="nc" id="L222">        int strength = 0;</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (hasLength) strength++;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (hasUpper) strength++;</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (hasLower) strength++;</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (hasDigit) strength++;</span>
        
<span class="nc" id="L228">        double progress = strength / 4.0;</span>
<span class="nc" id="L229">        passwordStrengthBar.setProgress(progress);</span>
        
        String strengthText;
        String colorStyle;
        
<span class="nc bnc" id="L234" title="All 5 branches missed.">        switch (strength) {</span>
            case 0:
<span class="nc" id="L236">                strengthText = &quot;Strength: None&quot;;</span>
<span class="nc" id="L237">                colorStyle = &quot;-fx-text-fill: #999;&quot;;</span>
<span class="nc" id="L238">                passwordStrengthBar.setStyle(&quot;-fx-control-inner-background: #e9ecef;&quot;);</span>
<span class="nc" id="L239">                break;</span>
            case 1:
<span class="nc" id="L241">                strengthText = &quot;Strength: Weak&quot;;</span>
<span class="nc" id="L242">                colorStyle = &quot;-fx-text-fill: #dc3545;&quot;;</span>
<span class="nc" id="L243">                passwordStrengthBar.setStyle(&quot;-fx-control-inner-background: #dc3545;&quot;);</span>
<span class="nc" id="L244">                break;</span>
            case 2:
<span class="nc" id="L246">                strengthText = &quot;Strength: Fair&quot;;</span>
<span class="nc" id="L247">                colorStyle = &quot;-fx-text-fill: #ffc107;&quot;;</span>
<span class="nc" id="L248">                passwordStrengthBar.setStyle(&quot;-fx-control-inner-background: #ffc107;&quot;);</span>
<span class="nc" id="L249">                break;</span>
            case 3:
<span class="nc" id="L251">                strengthText = &quot;Strength: Good&quot;;</span>
<span class="nc" id="L252">                colorStyle = &quot;-fx-text-fill: #17a2b8;&quot;;</span>
<span class="nc" id="L253">                passwordStrengthBar.setStyle(&quot;-fx-control-inner-background: #17a2b8;&quot;);</span>
<span class="nc" id="L254">                break;</span>
            default:
<span class="nc" id="L256">                strengthText = &quot;Strength: Strong&quot;;</span>
<span class="nc" id="L257">                colorStyle = &quot;-fx-text-fill: #28a745;&quot;;</span>
<span class="nc" id="L258">                passwordStrengthBar.setStyle(&quot;-fx-control-inner-background: #28a745;&quot;);</span>
        }
        
<span class="nc" id="L261">        strengthLabel.setText(strengthText);</span>
<span class="nc" id="L262">        strengthLabel.setStyle(colorStyle + &quot; -fx-font-size: 11px; -fx-font-weight: bold;&quot;);</span>
<span class="nc" id="L263">    }</span>
    
    /**
     * Check if new password and confirm password match
     */
    private void checkPasswordMatch() {
<span class="nc" id="L269">        String newPassword = newPasswordField.getText();</span>
<span class="nc" id="L270">        String confirmPassword = confirmPasswordField.getText();</span>
        
<span class="nc bnc" id="L272" title="All 4 branches missed.">        if (newPassword.isEmpty() || confirmPassword.isEmpty()) {</span>
<span class="nc" id="L273">            matchLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L274">            return;</span>
        }
        
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (newPassword.equals(confirmPassword)) {</span>
<span class="nc" id="L278">            matchLabel.setText(&quot;‚úì Passwords match&quot;);</span>
<span class="nc" id="L279">            matchLabel.setStyle(&quot;-fx-text-fill: #28a745; -fx-font-size: 11px;&quot;);</span>
        } else {
<span class="nc" id="L281">            matchLabel.setText(&quot;‚úó Passwords do not match&quot;);</span>
<span class="nc" id="L282">            matchLabel.setStyle(&quot;-fx-text-fill: #dc3545; -fx-font-size: 11px;&quot;);</span>
        }
<span class="nc" id="L284">    }</span>
    
    /**
     * Show error message
     */
    private void showError(String message) {
<span class="nc" id="L290">        errorLabel.setText(message);</span>
<span class="nc" id="L291">        errorLabel.setStyle(&quot;-fx-text-fill: #dc3545; -fx-font-size: 13px;&quot;);</span>
<span class="nc" id="L292">        successLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L293">        System.out.println(&quot;‚ö† Error: &quot; + message);</span>
<span class="nc" id="L294">    }</span>
    
    /**
     * Show success message
     */
    private void showSuccess(String message) {
<span class="nc" id="L300">        successLabel.setText(message);</span>
<span class="nc" id="L301">        successLabel.setStyle(&quot;-fx-text-fill: #28a745; -fx-font-size: 13px;&quot;);</span>
<span class="nc" id="L302">        errorLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L303">        System.out.println(&quot;‚úÖ Success: &quot; + message);</span>
<span class="nc" id="L304">    }</span>
    
    /**
     * Clear all message labels
     */
    private void clearMessages() {
<span class="nc" id="L310">        errorLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L311">        successLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L312">        matchLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L313">    }</span>
    
    /**
     * Close the window
     */
    private void closeWindow() {
<span class="nc" id="L319">        Stage stage = (Stage) currentPasswordField.getScene().getWindow();</span>
<span class="nc" id="L320">        stage.close();</span>
<span class="nc" id="L321">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>