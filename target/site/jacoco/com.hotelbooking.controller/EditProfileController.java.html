<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EditProfileController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HotelBookingSystem</a> &gt; <a href="index.source.html" class="el_package">com.hotelbooking.controller</a> &gt; <span class="el_source">EditProfileController.java</span></div><h1>EditProfileController.java</h1><pre class="source lang-java linenums">package com.hotelbooking.controller;

import com.hotelbooking.dao.UserDAO;
import com.hotelbooking.entity.User;
import com.hotelbooking.util.SessionManager;
import javafx.application.Platform;
import javafx.fxml.FXML;
import javafx.scene.control.Label;
import javafx.scene.control.TextField;
import javafx.stage.Stage;

import java.util.regex.Pattern;

<span class="nc" id="L14">public class EditProfileController {</span>
    
    @FXML  TextField usernameField;
    @FXML  TextField emailField;
    @FXML  TextField fullNameField;
    @FXML  Label errorLabel;
    @FXML  Label successLabel;
    
    private User currentUser;
    private UserDAO userDAO;
    private OnSaveCallback onSaveCallback;
    private String originalUsername; // å­˜å‚¨åŸå§‹username
    private String originalEmail;    // å­˜å‚¨åŸå§‹email
    
    // Email validation regex
    private static final String EMAIL_REGEX = 
        &quot;^[A-Za-z0-9+_.-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})$&quot;;
<span class="nc" id="L31">    private static final Pattern EMAIL_PATTERN = Pattern.compile(EMAIL_REGEX);</span>
    
    @FXML
    public void initialize() {
<span class="nc" id="L35">        userDAO = new UserDAO();</span>
<span class="nc" id="L36">        loadUserData();</span>
<span class="nc" id="L37">    }</span>
    
    private void loadUserData() {
<span class="nc" id="L40">        currentUser = SessionManager.getCurrentUser();</span>
        
<span class="nc bnc" id="L42" title="All 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L43">            showError(&quot;No user logged in!&quot;);</span>
<span class="nc" id="L44">            return;</span>
        }
        
<span class="nc" id="L47">        originalUsername = currentUser.getUsername();</span>
<span class="nc" id="L48">        originalEmail = currentUser.getEmail();</span>
        
<span class="nc" id="L50">        usernameField.setText(currentUser.getUsername());</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        emailField.setText(currentUser.getEmail() != null ? currentUser.getEmail() : &quot;&quot;);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">        fullNameField.setText(currentUser.getFullName() != null ? currentUser.getFullName() : &quot;&quot;);</span>
        
<span class="nc" id="L54">        clearMessages();</span>
<span class="nc" id="L55">        System.out.println(&quot;âœ… User data loaded for editing: &quot; + currentUser.getUsername());</span>
<span class="nc" id="L56">    }</span>
    
    @FXML
     void handleSave() {
<span class="nc" id="L60">        clearMessages();</span>
        
        // Validation
<span class="nc" id="L63">        String validationError = validateInput();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (!validationError.isEmpty()) {</span>
<span class="nc" id="L65">            showError(validationError);</span>
<span class="nc" id="L66">            return;</span>
        }
        
        try {
<span class="nc" id="L70">            String newUsername = usernameField.getText().trim();</span>
<span class="nc" id="L71">            String newEmail = emailField.getText().trim();</span>
<span class="nc" id="L72">            String newFullName = fullNameField.getText().trim();</span>
            
            // â­ æ£€æŸ¥æ–°usernameæ˜¯å¦å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨ï¼ˆå¦‚æœusernameè¢«ä¿®æ”¹äº†ï¼‰
<span class="nc bnc" id="L75" title="All 2 branches missed.">            if (!newUsername.equals(originalUsername)) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">                if (userDAO.isUsernameExists(newUsername)) {</span>
<span class="nc" id="L77">                    showError(&quot;âŒ This username is already taken&quot;);</span>
<span class="nc" id="L78">                    System.out.println(&quot;âš  Username already exists: &quot; + newUsername);</span>
<span class="nc" id="L79">                    return;</span>
                }
            }
            
            // â­ æ£€æŸ¥æ–°emailæ˜¯å¦å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨ï¼ˆå¦‚æœemailè¢«ä¿®æ”¹äº†ï¼‰
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (!newEmail.equals(originalEmail)) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                if (userDAO.isEmailExists(newEmail)) {</span>
<span class="nc" id="L86">                    showError(&quot;âŒ This email is already registered&quot;);</span>
<span class="nc" id="L87">                    System.out.println(&quot;âš  Email already exists: &quot; + newEmail);</span>
<span class="nc" id="L88">                    return;</span>
                }
            }
            
            // â­ ä½¿ç”¨ updateUserProfile() æ–¹æ³•ä¿å­˜usernameå’Œemail
<span class="nc" id="L93">            boolean isUpdated = userDAO.updateUserProfile(currentUser.getId(), newUsername, newEmail);</span>
            
<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (isUpdated) {</span>
                // â­ æ›´æ–°å†…å­˜ä¸­çš„userå¯¹è±¡
<span class="nc" id="L97">                currentUser.setUsername(newUsername);</span>
<span class="nc" id="L98">                currentUser.setEmail(newEmail);</span>
<span class="nc" id="L99">                currentUser.setFullName(newFullName);</span>
                
                // â­ æ›´æ–°Sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯
<span class="nc" id="L102">                SessionManager.setCurrentUser(currentUser);</span>
                
<span class="nc" id="L104">                showSuccess(&quot;âœ… Profile updated successfully!&quot;);</span>
<span class="nc" id="L105">                System.out.println(&quot;ğŸ’¾ Profile saved - Username: &quot; + newUsername + &quot;, Email: &quot; + newEmail + &quot;, FullName: &quot; + newFullName);</span>
                
                // è°ƒç”¨å›è°ƒå‡½æ•°
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (onSaveCallback != null) {</span>
<span class="nc" id="L109">                    onSaveCallback.onSave();</span>
                }
                
                // å…³é—­çª—å£
<span class="nc" id="L113">                Platform.runLater(() -&gt; {</span>
                    try {
<span class="nc" id="L115">                        Thread.sleep(1500);</span>
<span class="nc" id="L116">                        closeWindow();</span>
<span class="nc" id="L117">                    } catch (InterruptedException e) {</span>
<span class="nc" id="L118">                        closeWindow();</span>
<span class="nc" id="L119">                    }</span>
<span class="nc" id="L120">                });</span>
            } else {
<span class="nc" id="L122">                showError(&quot;Failed to update profile in database&quot;);</span>
            }
            
<span class="nc" id="L125">        } catch (Exception e) {</span>
<span class="nc" id="L126">            System.err.println(&quot;âŒ Error saving profile: &quot; + e.getMessage());</span>
<span class="nc" id="L127">            showError(&quot;Failed to save profile. Please try again.&quot;);</span>
<span class="nc" id="L128">            e.printStackTrace();</span>
<span class="nc" id="L129">        }</span>
<span class="nc" id="L130">    }</span>
    
    @FXML
     void handleCancel() {
<span class="nc" id="L134">        closeWindow();</span>
<span class="nc" id="L135">    }</span>
    
    /**
     * â­ å®Œæ•´çš„è¾“å…¥éªŒè¯
     */
    String validateInput() {
<span class="nc" id="L141">        String username = usernameField.getText().trim();</span>
<span class="nc" id="L142">        String email = emailField.getText().trim();</span>
<span class="nc" id="L143">        String fullName = fullNameField.getText().trim();</span>
        
        // Username validation
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (username.isEmpty()) {</span>
<span class="nc" id="L147">            return &quot;Username cannot be empty&quot;;</span>
        }
        
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (username.length() &lt; 3) {</span>
<span class="nc" id="L151">            return &quot;Username must be at least 3 characters&quot;;</span>
        }
        
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (username.length() &gt; 50) {</span>
<span class="nc" id="L155">            return &quot;Username is too long (max 50 characters)&quot;;</span>
        }
        
        // Usernameåªå…è®¸å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (!username.matches(&quot;^[a-zA-Z0-9_]+$&quot;)) {</span>
<span class="nc" id="L160">            return &quot;Username can only contain letters, numbers, and underscores&quot;;</span>
        }
        
        // Email validation
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (email.isEmpty()) {</span>
<span class="nc" id="L165">            return &quot;Email address cannot be empty&quot;;</span>
        }
        
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (email.length() &gt; 100) {</span>
<span class="nc" id="L169">            return &quot;Email address is too long (max 100 characters)&quot;;</span>
        }
        
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (!EMAIL_PATTERN.matcher(email).matches()) {</span>
<span class="nc" id="L173">            return &quot;Please enter a valid email address&quot;;</span>
        }
        
        // Full Name validation
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (fullName.isEmpty()) {</span>
<span class="nc" id="L178">            return &quot;Full name cannot be empty&quot;;</span>
        }
        
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (fullName.length() &lt; 2) {</span>
<span class="nc" id="L182">            return &quot;Full name must be at least 2 characters&quot;;</span>
        }
        
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (fullName.length() &gt; 100) {</span>
<span class="nc" id="L186">            return &quot;Full name is too long (max 100 characters)&quot;;</span>
        }
        
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (!fullName.matches(&quot;^[a-zA-Z\\s\\-']+$&quot;)) {</span>
<span class="nc" id="L190">            return &quot;Full name can only contain letters, spaces, hyphens, and apostrophes&quot;;</span>
        }
        
<span class="nc" id="L193">        return &quot;&quot;;</span>
    }
    
    private void showError(String message) {
<span class="nc" id="L197">        errorLabel.setText(message);</span>
<span class="nc" id="L198">        errorLabel.setStyle(&quot;-fx-text-fill: #dc3545; -fx-font-size: 13px;&quot;);</span>
<span class="nc" id="L199">        successLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L200">        System.out.println(&quot;âš  Error: &quot; + message);</span>
<span class="nc" id="L201">    }</span>
    
    private void showSuccess(String message) {
<span class="nc" id="L204">        successLabel.setText(message);</span>
<span class="nc" id="L205">        successLabel.setStyle(&quot;-fx-text-fill: #28a745; -fx-font-size: 13px;&quot;);</span>
<span class="nc" id="L206">        errorLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L207">        System.out.println(&quot;âœ… Success: &quot; + message);</span>
<span class="nc" id="L208">    }</span>
    
    private void clearMessages() {
<span class="nc" id="L211">        errorLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L212">        successLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L213">    }</span>
    
    private void closeWindow() {
<span class="nc" id="L216">        Stage stage = (Stage) usernameField.getScene().getWindow();</span>
<span class="nc" id="L217">        stage.close();</span>
<span class="nc" id="L218">    }</span>
    
    public interface OnSaveCallback {
        void onSave();
    }
    
    public void setOnSaveCallback(OnSaveCallback callback) {
<span class="nc" id="L225">        this.onSaveCallback = callback;</span>
<span class="nc" id="L226">        System.out.println(&quot;ğŸ“ Save callback set&quot;);</span>
<span class="nc" id="L227">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>